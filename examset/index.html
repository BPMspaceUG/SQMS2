<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Exam Set Wizard | SQMS2</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
</head>
<body>

    <div class="container py-3">
        <h4 class="my-4 text-primary">Exam Set Wizard ðŸ§™</h4>

        <!-- 1. SYLLABUS -->
        <section id="step1" class="card p-3 mb-3 border-success">
            <p>1. Select a Syllabus</p>
            <select class="custom-select" id="lstSyllabus"></select>
            <hr>
            <button id="btnStep1" class="btn btn-success w-25 mx-auto">&rarr; Create 3 Exam Sets</button>
        </section>

        <!-- 2. QUESTIONS -->
        <section id="step2" style="display:none;" class="card p-3 mb-3 border-success">
            <p>2. Select Questions from Syllabus (drag or press ctrl to multi-select)</p>
            <select class="custom-select" id="lstQuestion" multiple></select>
            <hr>
            <button id="btnStep2" class="btn btn-success w-25 mx-auto">&rarr; Create Entries in sqms2_question_examsetversion</button>
        </section>

        <!-- 3. ANSWERS -->
        <section id="step3" style="display:none;" class="card p-3 mb-3">
            <p>3. Select Answers from Questions</p>
            <p><span id="txtActQuest">1</span> / <span id="txtCntQuest">2</span> : <span id="txtQuestion" class="font-weight-bold text-primary">What is the Question?</span></p>
            <div class="row">
                <div class="col text-success" id="lstAnswCorr"></div>
                <div class="col text-danger" id="lstAnswWron"></div>
            </div>
            <table class="table table-borderless table-sm">
                <thead>
                    <tr>
                    <th scope="col">Exam Set Version</th>
                    <th scope="col">Answer 1</th>
                    <th scope="col">Answer 2</th>
                    <th scope="col">Answer 3</th>
                    <th scope="col">Answer 4</th>
                    <th scope="col">Answer 5</th>
                    <th scope="col">Answer 6</th>
                    </tr>
                </thead>
                <tbody id="tblSets">
                    <tr>
                    <td>Scrum Foundation - LIVE</td>
                    <td><select class="custom-select custom-select-sm"><option selected></option><option>1</option><option>2</option><option>3</option></select></td>
                    <td><select class="custom-select custom-select-sm"><option selected></option><option>1</option><option>2</option><option>3</option></select></td>
                    <td><select class="custom-select custom-select-sm"><option selected></option><option>1</option><option>2</option><option>3</option></select></td>
                    <td><select class="custom-select custom-select-sm"><option selected></option><option>1</option><option>2</option><option>3</option></select></td>
                    <td><select class="custom-select custom-select-sm"><option selected></option><option>1</option><option>2</option><option>3</option></select></td>
                    <td><select class="custom-select custom-select-sm"><option selected></option><option>1</option><option>2</option><option>3</option></select></td>
                    </tr>
                </tbody>
            </table>
            <hr>
            <button id="btnStep3next" class="btn btn-success w-25 mx-auto">&rarr; Create Entry in sqms2_question_examsetversion_answer</button>
        </section>

        <!-- 4. FINISHED -->
        <section id="step4" style="display:none;" class="card p-3 mb-3">
            <p>4. Wizard complete!</p>
        </section>

    </div>

    <!-- JS -->
    <script>
        function stripHtml(html) {
            const tmp = document.createElement("DIV");
            tmp.innerHTML = html;
            return tmp.textContent || tmp.innerText || "";
        }
        function appendList(id, eID, eTitle) {
            const opt = document.createElement('option');
            opt.setAttribute('value', eID);
            opt.innerText = eTitle;
            // Append to List                
            document.getElementById(id).appendChild(opt);
        }

        //=======================================================
        let idxQuestion = 0;
        const allQuestions = [];
        const selQuestions = [];

        loadQuestion = function() {            
            document.getElementById('txtActQuest').innerText = idxQuestion + 1;
            document.getElementById('txtCntQuest').innerText = selQuestions.length;
            document.getElementById('txtQuestion').innerText = selQuestions[idxQuestion].name;

            const qid = selQuestions[idxQuestion].id;
            const corrAnswers = [];
            const wrngAnswers = [];

            // Load Answers to Question
            fetch('../api.php?table=sqms2_question_answer&filter={"=":["sqms2_Question_id",'+qid+']}').then(resp=>resp.json()).then(res=>{
                for (const row of res['records']) {
                    const a = row.sqms2_Answer_id_fk_995603;
                    fetch('../api.php?table=sqms2_answer_text&filter={"=":["sqms2_Answer_id",'+a.sqms2_Answer_id+']}').then(resp=>resp.json()).then(res2=>{
                        for (const row of res2['records']) {
                            const t = row.sqms2_Text_id_fk_842740;
                            if (t.sqms2_language_iso_short == 'EN') { // Language
                                const txt = stripHtml(t.sqms2_Text);
                                if (a.sqms2_correct === 1) {
                                    corrAnswers.push({id: a.sqms2_Answer_id, name: txt});
                                    document.getElementById('lstAnswCorr').innerHTML += a.sqms2_Answer_id + ')&nbsp;<b>' + txt + '<b><br>';
                                }
                                else {
                                    wrngAnswers.push({id: a.sqms2_Answer_id, name: txt});
                                    document.getElementById('lstAnswWron').innerHTML += a.sqms2_Answer_id + ')&nbsp;<b>' + txt + '</b><br>'; 
                                }
                            }
                        }
                    });
                }
            });

            console.log(corrAnswers, wrngAnswers);
        }
        // Load all Syllabi
        fetch('../api.php?table=sqms2_syllabus&filter={"in":["state_id","7462,7463"]}').then(resp => resp.json()).then(res => {
            for (const row of res['records'])
                appendList('lstSyllabus', row.sqms2_Syllabus_id, row.sqms2_Syllabus_titel);
        });


        //--- Selected Syllabus [1] -> [2]
        document.getElementById('btnStep1').addEventListener('click', () => {
            const e = document.getElementById('lstSyllabus');
            const Syllabus = e.options[e.selectedIndex];
            for (const i of [1,2,3]) {
                // create one object
                fetch('../api.php', {method:'POST', body:JSON.stringify({cmd:'create', param:{
                table: "sqms2_examsetversion",
                row:{
                    sqms2_ExamSetVersion_title: Syllabus.text + " - SAMPLE SET " + i,
                    sqms2_ExamSetVersion_SampleSet: 1
                }}})}).then(resp => resp.json()).then(res => {});
            }
            // next Step
            //alert("Created 3 Exam Set Versions");
            document.getElementById('step1').style.display = "none";
            document.getElementById('step2').style.display = "block";
            // Prepare Step 2
            // 1. Read out all syllabuschapters from syllabus
            fetch('../api.php?table=sqms2_syllabus_syllabuschapter&filter={"=":["sqms2_Syllabus_id",'+Syllabus.value+']}').then(resp => resp.json()).then(res => {
                for (const row of res['records']) {
                    const SCid = row.sqms2_SyllabusChapter_id_fk_327935.sqms2_SyllabusChapter_id;
                    // 2. Read out all questions from chapters
                    fetch('../api.php?table=sqms2_syllabuschapter_question&filter={"=":["sqms2_SyllabusChapter_id",'+SCid+']}').then(resp => resp.json()).then(res => {
                        for (const row of res['records']) {
                            const quest = row.sqms2_Question_id_fk_285826;
                            // 3. Read out questiontexts
                            fetch('../api.php?table=sqms2_question_text&filter={"=":["sqms2_Question_id",'+quest.sqms2_Question_id+']}').then(resp => resp.json()).then(res => {
                                for (const row of res['records']) {
                                    const Questiontext = row.sqms2_Text_id_fk_559100;
                                    const text = stripHtml(Questiontext.sqms2_Text);
                                    // Append to List
                                    allQuestions.push({id: quest.sqms2_Question_id, name: text});
                                    appendList('lstQuestion', quest.sqms2_Question_id, text);
                                }
                            });
                        }
                    });
                }
            });
        });
    
        //--- Selected Questions [2] -> [3]
        document.getElementById('btnStep2').addEventListener('click', () => {
            idxQuestion = 0;
            Array.from(document.querySelectorAll('#lstQuestion option:checked')).map(el => {
                selQuestions.push({id: parseInt(el.value), name: el.innerText});
            });
            console.log("Create Entries in sqms2_question_examsetversion", selQuestions);

            loadQuestion();

            document.getElementById('step2').style.display = "none";
            document.getElementById('step3').style.display = "block";
        });

        //--- Finish [3] -> [4]
        document.getElementById('btnStep3next').addEventListener('click', () => {
            idxQuestion++;
            if (idxQuestion >= selQuestions.length) {
                //alert("Wizard finished!");
                document.getElementById('step3').style.display = "none";
                document.getElementById('step4').style.display = "block";
            }
            else {
                // TODO: Write Link sqms2_question_examsetversion_answer
                console.log("Create Entries in sqms2_question_examsetversion_answer", selQuestions);
                loadQuestion();
            }                
        });

    </script>
</body>
</html>