<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Exam Set Wizard | SQMS2</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <style>
        section p:first-of-type {color:gray; border-bottom: 1px solid whitesmoke;}
    </style>
</head>
<body>

    <div class="container py-3">
        <h4 class="my-4 text-primary">Exam Set Wizard üßô</h4>

        <!-- 1. SYLLABUS -->
        <section id="step1" class="card p-3 mb-3">
            <p>1. Select a Syllabus</p>
            <select class="custom-select" id="lstSyllabus"></select>
            <hr>
            <button id="btnStep1" class="btn btn-success w-25 mx-auto">&rarr; Next</button>
        </section>

        <!-- 2. QUESTIONS -->
        <section id="step2" style="display:none;" class="card p-3 mb-3">
            <div class="row">
                <p class="col-10">2. Select Questions from Syllabus (drag or press ctrl to multi-select)</p>
                <div class="col-2">
                    <select class="custom-select custom-select-sm" onchange="changeQuestLang(this)">
                        <option value="EN" selected>english</option>
                        <option value="DE">deutsch</option>
                        <option value="IT">italiano</option>
                        <option value="FR">fran√ßais</option>
                        <option value="SP">espa√±ol</option>
                    </select>
                </div>
            </div>
            <select class="custom-select" id="lstQuestion" multiple></select>
            <hr>
            <button id="btnStep2" class="btn btn-success w-25 mx-auto">&rarr; Next</button>
        </section>

        <!-- 3. ANSWERS -->
        <section id="step3" style="display:none;" class="card p-3 mb-3">
            <div class="row">
                <p class="col-10">3. Select Answers from Questions</p>
                <div class="col-2">
                    <select class="custom-select custom-select-sm" onchange="changeAnswLang(this)">
                        <option value="EN" selected>english</option>
                        <option value="DE">deutsch</option>
                        <option value="IT">italiano</option>
                        <option value="FR">fran√ßais</option>
                        <option value="SP">espa√±ol</option>
                    </select>
                </div>
            </div>

            <p>‚ùî <span id="txtActQuest">1</span> / <span id="txtCntQuest">2</span> : <span id="txtQuestion" class="font-weight-bold text-primary">What is the Question?</span></p>
            <div class="row mb-3">
                <div class="col text-success" id="lstAnswCorr"></div>
                <div class="col text-danger" id="lstAnswWron"></div>
            </div>
            <table class="table table-borderless table-sm">
                <thead>
                    <tr>
                    <th scope="col">Exam Set Version</th>
                    <th scope="col">Answer 1</th>
                    <th scope="col">Answer 2</th>
                    <th scope="col">Answer 3</th>
                    <th scope="col">Answer 4</th>
                    <th scope="col">Answer 5</th>
                    <th scope="col">Answer 6</th>
                    </tr>
                </thead>
                <tbody id="tblSets"></tbody>
            </table>
            <hr>
            <button id="btnStep3next" class="btn btn-success w-25 mx-auto">&rarr; Next</button>
        </section>

        <!-- 4. FINISHED -->
        <section id="step4" style="display:none;" class="card p-3 mb-3 text-center">
            <p>4. Finish</p>
            <h4>Wizard complete!</h4>
            <a href="javascript:void(0);" onclick="window.history.back();" class="btn btn-primary btn-lg">Back</a>
        </section>

    </div>



    <!-- JS -->
    <script>
        let log = (x) => console.log(x);

        function stripHtml(html) {
            const tmp = document.createElement("DIV");
            tmp.innerHTML = html;
            return tmp.textContent || tmp.innerText || "";
        }
        function appendList(elem, eID, eTitle, specialClasses = null)  {
            const opt = document.createElement('option');
            opt.setAttribute('value', eID);
            if (specialClasses) opt.setAttribute('class', specialClasses)
            opt.innerText = eTitle;
            opt.addEventListener('click', () => {
                log("selected AnswerID = " + eID);
                elem.classList.remove("bg-danger");
                elem.classList.remove("bg-success");
                elem.classList.add(specialClasses);
            })
            // Append to List                
            elem.appendChild(opt);
        }
        //=======================================================
        let idxQuestion = 0;
        let SyllabusID = null;
        const gQuestions = [];
        const gSets = [];
        const gQuestionSets = [];

        // Load List of Questions in Lang
        loadQuestions = function(syllID, lang = 'EN') {
            document.getElementById('lstQuestion').innerHTML = "";          
            fetch('../api.php?table=sqms2_syllabus_syllabuschapter&filter={"=":["sqms2_Syllabus_id",'+syllID+']}').then(resp => resp.json()).then(res => {
                for (const row of res['records']) {
                    const SCid = row.sqms2_SyllabusChapter_id_fk_327935.sqms2_SyllabusChapter_id;
                    // 2. Read out all questions from chapters
                    fetch('../api.php?table=sqms2_syllabuschapter_question&filter={"=":["sqms2_SyllabusChapter_id",'+SCid+']}').then(resp => resp.json()).then(res => {
                        for (const row of res['records']) {
                            const quest = row.sqms2_Question_id_fk_285826;
                            // 3. Read out questiontexts
                            fetch('../api.php?table=sqms2_question_text&filter={"=":["sqms2_Question_id",'+quest.sqms2_Question_id+']}').then(resp => resp.json()).then(res => {
                                for (const row of res['records']) {
                                    //console.log(row);
                                    const Questiontext = row.sqms2_Text_id_fk_559100;
                                    if (Questiontext.sqms2_language_iso_short == lang) {
                                        const text = stripHtml(Questiontext.sqms2_Text);
                                        // Append to List
                                        appendList(document.getElementById('lstQuestion'), quest.sqms2_Question_id, text);
                                    }
                                }
                            });
                        }
                    });
                }
            });
        }
        
        // Question and Answers drawing (GUI)
        loadQuestion = function(lang = 'EN') {
            const qid = gQuestions[idxQuestion].id;
            //--- Init + Clear
            document.getElementById('txtActQuest').innerText = idxQuestion + 1;
            document.getElementById('txtCntQuest').innerText = gQuestions.length;
            document.getElementById('txtQuestion').innerText = gQuestions[idxQuestion].name;
            document.getElementById('lstAnswCorr').innerHTML = "";
            document.getElementById('lstAnswWron').innerHTML = "";
            const all = document.getElementsByClassName('answerbox');
            for (let i=0;i<all.length;i++) all[i].innerHTML = '<option selected></option>';
            //--- Fetch Q-A
            fetch('../api.php?table=sqms2_question_answer&filter={"=":["sqms2_Question_id",'+qid+']}').then(resp=>resp.json()).then(res=>{
                for (const row of res['records']) {
                    const a = row.sqms2_Answer_id_fk_995603;
                    // Fetch A-T
                    fetch('../api.php?table=sqms2_answer_text&filter={"=":["sqms2_Answer_id",'+a.sqms2_Answer_id+']}').then(resp=>resp.json()).then(res2=>{
                        for (const row of res2['records']) {
                            const t = row.sqms2_Text_id_fk_842740;
                            if (t.sqms2_language_iso_short == lang) { // Language
                                // Set params
                                const id = a.sqms2_Answer_id;
                                const name = stripHtml(t.sqms2_Text);
                                // Right / Wrong?
                                if (a.sqms2_correct === 1)
                                    document.getElementById('lstAnswCorr').innerHTML += id+')&nbsp;<b>'+name+'<b><br>';
                                else 
                                    document.getElementById('lstAnswWron').innerHTML += id+')&nbsp;<b>'+name+'</b><br>'; 
                                // all
                                const all = document.getElementsByClassName('answerbox');
                                for (let i=0;i<all.length;i++) {
                                    all[i].classList.remove('bg-danger');
                                    all[i].classList.remove('bg-success');
                                    appendList(all[i], id, id, a.sqms2_correct === 1 ? 'bg-success' : 'bg-danger');
                                }
                            }
                        }
                    });
                }
            });
        }

        changeQuestLang = function(el) { loadQuestions(SyllabusID, el.value) }
        changeAnswLang = function(el) { loadQuestion(el.value) }

        // Load all Syllabi
        fetch('../api.php?table=sqms2_syllabus&filter={"in":["state_id","7462,7463"]}').then(resp => resp.json()).then(res => {
            for (const row of res['records'])
                appendList(document.getElementById('lstSyllabus'), row.sqms2_Syllabus_id, row.sqms2_Syllabus_titel);
        });

        //==============================================

        // [1] -> [2]
        document.getElementById('btnStep1').addEventListener('click', () => {
            const e = document.getElementById('lstSyllabus');
            const Syllabus = e.options[e.selectedIndex];
            SyllabusID = Syllabus.value;

            // Params -> 1 Sample, 2 Live
            const live = [1,1,0];
            const version = 1;
            let cntLive = 0, cntSample = 0;
            for (let i=0;i<live.length;i++) {
                let setname = "";
                let isSample = false;
                // Count up
                if (live[i] === 1) {
                    cntLive++;
                    setname = Syllabus.text + " - " + version + " - " + cntLive + ' - LIVE SET';
                }
                else {
                    cntSample++;
                    setname = Syllabus.text + " - " + version + " - " + cntSample + ' - SAMPLE SET';
                    isSample = true;
                }
                // create one object
                fetch('../api.php', {method:'POST', body:JSON.stringify({cmd:'create', param:{
                    table: "sqms2_examsetversion",
                    row:{
                        sqms2_ExamSetVersion_title: setname,
                        sqms2_ExamSetVersion_SampleSet: isSample ? "1" : "0",
                        sqms2_ExamSetVersion_Set: isSample ? cntSample : cntLive

                }}})}).then(resp => resp.json()).then(res => {
                    // append to Array
                    gSets.push({id: res[1].element_id, name: setname});
                });
            }
            // next Step
            document.getElementById('step1').style.display = "none";
            document.getElementById('step2').style.display = "block";
            // Prepare Step 2
            // 1. Read out all syllabuschapters from syllabus
            loadQuestions(Syllabus.value);

        });
    
        // [2] -> [3] Load Questions and Sets
        document.getElementById('btnStep2').addEventListener('click', () => {
            idxQuestion = 0;
            Array.from(document.querySelectorAll('#lstQuestion option:checked')).map(el => {
                gQuestions.push({id: parseInt(el.value), name: el.innerText});
            });

            // Create for each Set for each Question...
            gSets.forEach(set => {
                gQuestions.forEach(que => {
                    // create a Link
                    fetch('../api.php', {method:'POST', body:JSON.stringify({cmd:'create', param:{
                        table: "sqms2_question_examsetversion",
                        row:{
                            sqms2_ExamSetVersion_id_fk_264577: set.id,
                            sqms2_Question_id_fk_615560: que.id
                        }
                    }})}).then(resp => resp.json()).then(res => {
                        const x = {id: res[1].element_id, idS: parseInt(set.id), idQ: parseInt(que.id)};
                        //console.log(x);
                        gQuestionSets.push(x);
                    });
                });
            });


            // Load all Sets
            const tbl = document.getElementById('tblSets');
            for (const i of gSets) {
                const rowSet = document.createElement("tr");
                rowSet.setAttribute('id', 'set-' + i.id);
                rowSet.setAttribute('class', 'setRow');
                for (const j of [0,1,2,3,4,5,6]) {
                    // Col
                    const col = document.createElement("td");
                    col.innerHTML = j == 0 ?
                        i.name :
                        col.innerHTML = '<select id="SetIDAnsID_'+i.id+'_'+j+'" class="custom-select custom-select-sm text-white answerbox"><option selected></option></select>';
                    rowSet.appendChild(col);
                }
                tbl.appendChild(rowSet);
            }

            loadQuestion();

            document.getElementById('step2').style.display = "none";
            document.getElementById('step3').style.display = "block";
        });

        //--- Finish [3] -> [4]
        document.getElementById('btnStep3next').addEventListener('click', () => {
            const qid = gQuestions[idxQuestion].id; // actual Question ID
            // Loop sets
            document.getElementsByClassName('getting all queSetIDs...');
            gSets.map(set => {
                const setID = set.id;
                let qsID = null;
                for (const qs of gQuestionSets) {
                    if (qs.idS == setID && qs.idQ == qid)
                        qsID = qs.id;
                }
                // Get AnswerIDs for each set
                const answers = document.getElementById('set-' + setID).getElementsByClassName('answerbox');
                for (let i=0; i<answers.length; i++) {
                    const el = answers[i];
                    const AnswerID = el[el.selectedIndex].value;
                    //---- Create
                    if (AnswerID) {
                        // create a Link
                        fetch('../api.php', {method:'POST', body:JSON.stringify({cmd:'create', param:{
                            table: "sqms2_question_examsetversion_answer",
                            row:{
                                sqms2_Question_ExamSetVersion_id_fk_186326: qsID,
                                sqms2_Answer_id_fk_507266: AnswerID
                            }
                        }})}).then(resp => resp.json()).then(res => {});
                    }
                }
            })


            idxQuestion++;
            if (idxQuestion >= gQuestions.length) {
                // Wizard finished!
                document.getElementById('step3').style.display = "none";
                document.getElementById('step4').style.display = "block";
            }
            else {
                // Next Question please!
                loadQuestion();
            }     
        });
    </script>
</body>
</html>